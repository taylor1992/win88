<!-- 省略 head & layout，与上面一致，只改 title 为 Settlement Management -->

<div class="table_div">
    <div id="searchParam" sa:hasPermission="salesSettlement:list">
        <form class="layui-form" lay-filter="searchForm">
            <div class="layui-form-item">

                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px;">Settlement Date</label>
                    <div class="layui-input-inline">
                        <input type="text" id="settleDateBegin" name="settleDateBegin"
                               placeholder="Start date" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">-</div>
                    <div class="layui-input-inline">
                        <input type="text" id="settleDateEnd" name="settleDateEnd"
                               placeholder="End date" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">Platform</label>
                    <div class="layui-input-inline">
                        <select name="platformCode" id="sPlatform"></select>
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">Shop</label>
                    <div class="layui-input-inline">
                        <select name="shopId" id="sShop"></select>
                    </div>
                </div>

                <div class="layui-inline">
                    <button type="submit" class="layui-btn layui-btn-primary"
                            lay-submit lay-filter="data-search-btn">
                        <i class="layui-icon">&#xe615;</i> Search
                    </button>
                </div>

            </div>
        </form>
    </div>

    <table class="layui-table" id="showTable" lay-filter="showTable"></table>
</div>

<script type="text/html" id="toolbar">
    <div class="layui-btn-container oper">
        <button class="layui-btn layui-btn-sm layui-btn-normal" id="btn_import_settlement"
                sa:hasPermission="salesSettlement:import">Import Settlement</button>
    </div>
</script>

<script type="text/html" id="tool">
    <a class="layui-btn layui-btn-xs" lay-event="look">View</a>
</script>

<script>
    layui.use(['table','form','laydate','layer','upload'], function(){
        var table = layui.table;
        var form = layui.form;
        var laydate = layui.laydate;
        var layer = layui.layer;
        var upload = layui.upload;
        var $ = layui.$;

        var dictTypes = ['OrderPlatform','Shop'];
        loadDicts(dictTypes, function () {
            renderDictSelect('OrderPlatform', $('#sPlatform'), 'All platforms');
            renderDictSelect('Shop', $('#sShop'), 'All shops');
        });

        LaydateEn.render({elem:'#settleDateBegin', format:'yyyy-MM-dd', type:'date'});
        LaydateEn.render({elem:'#settleDateEnd', format:'yyyy-MM-dd', type:'date'});

        var tableIns1 = table.render({
            elem:'#showTable',
            contentType:'application/json',
            page:true,
            url: ctx + 'salesSettlement/listByPage',
            method:'POST',
            parseData:function (res) {
                return {
                    code: res.code,
                    msg: res.msg,
                    count: res.data ? res.data.total : 0,
                    data: res.data ? res.data.records : []
                };
            },
            cols:[[
                {type:'numbers', title:'#'},
                {field:'settlementDate', title:'Settlement Date', sort:true},
                {field:'platformCode', title:'Platform', templet:function(d){
                        return getDictLabel('OrderPlatform', d.platformCode);
                    }},
                {field:'shopId', title:'Shop', templet:function(d){
                        return getDictLabel('Shop', d.shopId);
                    }},
                {field:'platformOrderNo', title:'Order No'},
                {field:'incomeAmount', title:'Income Amount'},
                {field:'feeTotal', title:'Fee Total'},
                {field:'currency', title:'Currency'},
                {field:'updatedTime', title:'Updated Time', sort:true},
                {toolbar:'#tool', title:'Actions', fixed:'right'}
            ]],
            toolbar:'#toolbar'
        });

        form.on('submit(data-search-btn)', function(data){
            var b = data.field.settleDateBegin;
            var e = data.field.settleDateEnd;
            if (b && e && b > e){
                layer.msg('End date cannot be earlier than start date.');
                return false;
            }
            tableIns1.reload({
                page:{curr:1},
                where:data.field
            });
            return false;
        });

        // Import settlement excel
        upload.render({
            elem:'#btn_import_settlement',
            url: ctx + 'salesSettlement/import',
            accept:'file',
            exts:'xlsx|xls|csv',
            data:function(){
                var shopId = $('#sShop').val();
                if (!shopId){
                    layer.msg('Please select a shop before importing.');
                }
                return { shopId: shopId };
            },
            before:function(){
                var shopId = $('#sShop').val();
                if (!shopId){ return false; }
                layer.load(1);
            },
            done:function(res){
                layer.closeAll('loading');
                layer.msg(res.msg || 'Import finished.', {time:1500}, function(){
                    tableIns1.reload({page:{curr:1}});
                });
            },
            error:function(){
                layer.closeAll('loading');
                layer.msg('Upload failed, please retry.');
            }
        });
    });
</script>
