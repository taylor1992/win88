<!DOCTYPE html>
<html lang="en" xmlns:sa="http://www.thymeleaf.org/extras/sa-token"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sales Order Management & Import</title>
    <div th:replace="~{layout}"></div>
    <style>
        .layui-form-label {
            width: 110px;
        }
        .layui-input-inline {
            width: 200px;
        }

    </style>
</head>
<body>

<div class="table_div">
    <div id="searchParam" sa:hasPermission="salesOrder:list">
        <form class="layui-form" lay-filter="searchForm">
            <div class="layui-form-item">

                <div class="layui-inline">
                    <label class="layui-form-label">Shop Name</label>
                    <div class="layui-input-inline">
                        <select name="shopId" class="dict-select disabled" data-dict-type="Shop"
                                data-placeholder="All Platforms"></select>
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">Order No</label>
                    <div class="layui-input-inline">
                        <input type="text" name="platformOrderNo" placeholder="Platform Order No" autocomplete="off"
                               class="layui-input">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">Platform</label>
                    <div class="layui-input-inline">
                        <select name="platformCode" class="dict-select disabled" data-dict-type="PlatformCode"
                                data-placeholder="All Platforms"></select>
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">Status</label>
                    <div class="layui-input-inline">
                        <select name="orderStatus" class="dict-select disabled" data-dict-type="OrderStatus"
                                data-placeholder="All Statuses"></select>
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label"  style="width: 110px;">Order Time</label>
                    <div class="layui-input-inline">
                        <input type="text" autocomplete="off" placeholder="Select start time" class="layui-input" id="orderTimeBegin" name="orderTimeBegin">
                    </div>
                    <div class="layui-input-inline">
                        <input type="text" autocomplete="off" class="layui-input" placeholder="Select end time" id="orderTimeEnd" name="orderTimeEnd">
                    </div>
                </div>

                <div class="layui-inline">
                    <button type="submit" class="layui-btn layui-btn-primary"
                            lay-submit lay-filter="data-search-btn">
                        <i class="layui-icon">&#xe615;</i> Search
                    </button>
                </div>

            </div>
        </form>
    </div>

    <table class="layui-table" id="showTable" lay-filter="showTable"></table>
</div>

<script type="text/html" id="toolbar">
    <div class="layui-btn-container oper">
        <button class="layui-btn layui-btn-normal layui-btn-sm" lay-event="import" sa:hasPermission="salesOrder:import">
            <i class="layui-icon">&#xe67c;</i> Import Orders
        </button>
        <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="refresh">
            <i class="layui-icon">&#xe666;</i> Refresh
        </button>
    </div>
</script>

<script type="text/html" id="tool">
    <a class="layui-btn layui-btn-xs" lay-event="detail" sa:hasPermission="salesOrderDetail:view">View Details</a>
</script>

</body>
</html>

<script>
    window.APP_LANG = 'en'; // 沿用您的语言设置
</script>
<script th:src="@{/static/js/layui.i18n.js(v=${T(System).currentTimeMillis()})}"></script>
<script>
    layui.use(function () {
        var table = layui.table;
        var form = layui.form;
        var layer = layui.layer;
        var $ = layui.$;
        var upload = layui.upload;

        // 开始时间
        LaydateEn.render({
            elem: '#orderTimeBegin'
            // 也可以覆盖默认 format 等：
            // format: 'yyyy/MM/dd HH:mm'
        });

        // 结束时间
        LaydateEn.render({
            elem: '#orderTimeEnd'
        });
        var tableIns1;

        initDictSelects(function () {
            tableIns1 = renderTable();
        });

        // Table render: 订单列表
        function renderTable() {
            return table.render({
                elem: '#showTable',
                contentType: 'application/json',
                page: true,
                url: ctx + 'salesOrder/listByPage',
                method: 'POST',
                parseData: function (res) {
                    return {
                        code: res.code,
                        msg: res.msg,
                        count: CoreUtil.isEmpty(res.data) ? 0 : res.data.total,
                        data: CoreUtil.isEmpty(res.data) ? null : res.data.records
                    }
                },
                cols: [
                    [
                        {type: 'checkbox', fixed: 'left'},
                        {field: 'platformOrderNo', title: 'Order No', sort: true},
                        {
                            field: 'platformCode', title: 'Platform',  templet: function (param) {
                                return getDictLabel('PlatformCode', param.platformCode);
                            }
                        },
                        {
                            field: 'orderStatus', title: 'Status', sort: true, templet: function (param) {
                                return getDictLabel('OrderStatus', param.orderStatus);
                            }
                        },
                        {field: 'buyerPayAmount', title: 'Buyer Pay Amount',  sort: true},
                        {field: 'orderTime', width: 180, title: 'Order Time', sort: true},
                        {width: 100, toolbar: '#tool', title: 'Actions'}
                    ]
                ],
                toolbar: '#toolbar',
                where: form.val('searchForm')
            });
        }

        // Top toolbar event handling
        table.on('toolbar(showTable)', function (obj) {
            switch (obj.event) {
                case 'import':
                    openImportDialog(); // 打开导入弹窗
                    break;
                case 'refresh':
                    tableIns1.reload(); // 刷新列表
                    break;
            }
        });

        // Row tools event handling (View Details)
        table.on('tool(showTable)', function (obj) {
            var data = obj.data;
            if (obj.event === 'detail') {
                openDetailDialog(data);
            }
        });

        // Search
        form.on('submit(data-search-btn)', function (data) {
            tableIns1.reload({
                page: {curr: 1},
                where: data.field
            });
            return false;
        });

        // 核心导入功能：弹出 CSV 上传框 (包含店铺选择)
        function openImportDialog() {
            var uploadHtml =
                '<div style="padding: 20px 30px;">' +
                '  <form class="layui-form" lay-filter="importForm" id="importForm">' +

                '    <div class="layui-form-item">' +
                '      <label class="layui-form-label">Shop Select</label>' +
                '      <div class="layui-input-block">' +
                '        <select name="shopId" id="shopIdSelect" class="dict-select" data-dict-type="Shop" lay-verify="required" lay-search data-placeholder="Select a shop"></select>' +
                '      </div>' +
                '    </div>' +

                '    <div class="layui-form-item layui-upload-box">' +
                '      <div class="layui-upload-drag" id="uploadDragArea">' +
                '        <i class="layui-icon">&#xe67c;</i>' +
                '        <p>Click or drag **TikTok Order CSV** file here to upload</p>' +
                '        <p class="layui-upload-area-info" id="fileInfo"></p>' +
                '      </div>' +
                '      <div class="layui-progress layui-progress-big" lay-showpercent="yes" lay-filter="importProgress" style="margin-top: 15px; display: none;">' +
                '          <div class="layui-progress-bar layui-bg-blue" lay-percent="0%"></div>' +
                '      </div>' +
                '      <button type="button" class="layui-btn layui-btn-fluid layui-btn-normal" id="startUploadBtn" style="margin-top: 15px; display: none;">Start Upload & Import</button>' +
                '    </div>' +

                '  </form>' +
                '</div>';

            var uploadLayerIndex = layer.open({
                type: 1,
                title: 'Import Sales Orders (CSV)',
                area: ['470px', '420px'],
                content: uploadHtml,
                btn: ['Close'],
                end: function () {
                }
            });

            // 重新渲染字典选择框
            initDictSelects(function () {
                form.render('select', 'importForm');
            });

            // 绑定上传事件
            upload.render({
                elem: '#uploadDragArea',
                url: ctx + 'salesOrder/importCsv',
                accept: 'file',
                exts: 'csv',
                auto: false,
                bindAction: '#startUploadBtn',
                field: 'file',
                drag: true,
                data: {
                    // 动态获取店铺 ID
                    shopId: function () {
                        return $('#shopIdSelect').val();
                    }
                },
                before: function (obj) {
                    var shopId = $('#shopIdSelect').val();
                    if (!shopId) {
                        layer.msg('Please select a shop first.', {icon: 5});
                        return false;
                    }

                    $('#startUploadBtn').addClass('layui-btn-disabled').prop('disabled', true);
                    layui.element.progress('importProgress', '0%');
                    $('.layui-progress').show();
                },
                choose: function (obj) {
                    var files = obj.pushFile();
                    var fileName = Object.keys(files)[0];
                    $('#fileInfo').html('Selected file: <strong style="color: #5fb878;">' + files[fileName].name + '</strong>');
                    $('#startUploadBtn').show().removeClass('layui-btn-disabled').prop('disabled', false);

                    obj.progress(function (n, elem) {
                        layui.element.progress('importProgress', n + '%');
                    });
                },
                done: function (res) {
                    $('#startUploadBtn').hide();
                    if (res.code === 0) {
                        var count = res.data && res.data.count ? res.data.count : 'N';
                        layer.msg('Import successful, ' + count + ' orders processed.', {icon: 1, time: 2000});
                        tableIns1.reload();
                        layer.close(uploadLayerIndex);
                    } else {
                        layer.alert('Import failed: ' + res.msg, {icon: 2});
                    }
                },
                error: function (index, uploadMsg) {
                    $('#startUploadBtn').hide();
                    layer.alert('File upload failed. Please check the network or backend service.', {icon: 2});
                }
            });
        }

        function openDetailDialog(row) {
            layer.open({
                type: 2,
                title: 'Order Details: ' + row.platformOrderNo,
                area: ['90%', '80%'],
                content: ctx + 'salesOrder/sales-order-detail?platformOrderNo=' + row.platformOrderNo
            });
        }
    });
</script>