<!DOCTYPE html>
<html lang="en"
      xmlns:sa="http://www.thymeleaf.org/extras/sa-token"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Order Management</title>
    <div th:replace="~{layout}"></div>
</head>
<body>

<!-- ============== Order form (view only for now) ============== -->
<div class="panel panel-default operation" hidden>
    <div class="panel-heading title"></div>
    <div class="layui-card-body">
        <form class="layui-form" action="" lay-filter="info">
            <input name="id" hidden/>

            <div class="layui-form-item">
                <label class="layui-form-label">Order Date</label>
                <div class="layui-input-block">
                    <input type="text" id="order_date_form" name="orderDate"
                           placeholder="Select order date"
                           autocomplete="off" class="layui-input disabled">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">Platform</label>
                <div class="layui-input-block">
                    <select name="platformCode" id="platform_form" class="disabled"></select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">Shop</label>
                <div class="layui-input-block">
                    <select name="shopId" id="shop_form" class="disabled"></select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">Order No</label>
                <div class="layui-input-block">
                    <input type="text" name="platformOrderNo"
                           placeholder="Platform order no."
                           autocomplete="off" class="layui-input disabled">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">Status</label>
                <div class="layui-input-block">
                    <select name="orderStatus" id="status_form" class="disabled"></select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">Buyer Paid</label>
                <div class="layui-input-block">
                    <input type="number" step="0.01" name="buyerPayAmount"
                           placeholder="Buyer payment amount"
                           autocomplete="off" class="layui-input disabled">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">Seller Receivable</label>
                <div class="layui-input-block">
                    <input type="number" step="0.01" name="sellerReceivableAmount"
                           placeholder="Seller receivable amount"
                           autocomplete="off" class="layui-input disabled">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">Currency</label>
                <div class="layui-input-block">
                    <input type="text" name="currency"
                           placeholder="Order currency, e.g. PHP"
                           autocomplete="off" class="layui-input disabled">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">Remark</label>
                <div class="layui-input-block">
                    <textarea name="remark"
                              placeholder="Optional remark"
                              class="layui-textarea disabled"></textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <!-- 订单一般不手工新增/编辑，这里可以保留按钮，暂时禁用 -->
                    <button type="submit" class="layui-btn" lay-submit lay-filter="submit">Save</button>
                    <button class="layui-btn layui-btn-primary" id="btn_cancel">Back</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- ============== List area ============== -->
<div class="table_div">
    <div id="searchParam" sa:hasPermission="salesOrder:list">
        <form class="layui-form" lay-filter="searchForm">
            <div class="layui-form-item">

                <!-- Order date range -->
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px;">Order Date</label>
                    <div class="layui-input-inline">
                        <input type="text" id="orderDateBegin" name="orderDateBegin"
                               placeholder="Start date" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">-</div>
                    <div class="layui-input-inline">
                        <input type="text" id="orderDateEnd" name="orderDateEnd"
                               placeholder="End date" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <!-- Platform -->
                <div class="layui-inline">
                    <label class="layui-form-label">Platform</label>
                    <div class="layui-input-inline">
                        <select name="platformCode" id="sPlatform"></select>
                    </div>
                </div>

                <!-- Shop -->
                <div class="layui-inline">
                    <label class="layui-form-label">Shop</label>
                    <div class="layui-input-inline">
                        <select name="shopId" id="sShop"></select>
                    </div>
                </div>

                <!-- Order status -->
                <div class="layui-inline">
                    <label class="layui-form-label">Status</label>
                    <div class="layui-input-inline">
                        <select name="orderStatus" id="sStatus"></select>
                    </div>
                </div>

                <!-- Search -->
                <div class="layui-inline">
                    <button type="submit" class="layui-btn layui-btn-primary"
                            lay-submit lay-filter="data-search-btn">
                        <i class="layui-icon">&#xe615;</i> Search
                    </button>
                </div>

            </div>
        </form>
    </div>

    <table class="layui-table" id="showTable" lay-filter="showTable"></table>
</div>

<!-- Toolbar -->
<script type="text/html" id="toolbar">
    <div class="layui-btn-container oper">
        <!-- 如果不支持手工新增，可去掉 Add -->
        <!--<button class="layui-btn layui-btn-sm" lay-event="add"
                sa:hasPermission="salesOrder:add">Add</button>-->
        <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="batchDeleted"
                sa:hasPermission="salesOrder:delete">Delete
        </button>

        <!-- Import orders -->
        <button class="layui-btn layui-btn-sm layui-btn-normal" id="btn_import_orders"
                sa:hasPermission="salesOrder:import">Import Orders
        </button>
    </div>
</script>

<!-- Row tools -->
<script type="text/html" id="tool">
    <a class="layui-btn layui-btn-xs" lay-event="look">View</a>
    <!-- 通常订单不允许编辑金额类字段，可以视情况隐藏 Edit -->
    <!--<a class="layui-btn layui-btn-xs" lay-event="edit"
       sa:hasPermission="salesOrder:update">Edit</a>-->
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"
       sa:hasPermission="salesOrder:delete">Delete</a>
</script>

</body>
</html>

<!-- 国际化 -->
<script>
    window.APP_LANG = 'en';
</script>
<script th:src="@{/static/js/layui.i18n.js(v=${T(System).currentTimeMillis()})}"></script>

<script>
    layui.use(['table', 'form', 'laydate', 'layer', 'upload'], function () {
        var table = layui.table;
        var form = layui.form;
        var laydate = layui.laydate;
        var layer = layui.layer;
        var upload = layui.upload;
        var $ = layui.$;

        var dictTypes = ['OrderPlatform', 'Shop', 'OrderStatus'];

        loadDicts(dictTypes, function () {
            renderDictSelect('OrderPlatform', $('#sPlatform'), 'All platforms');
            renderDictSelect('OrderPlatform', $('#platform_form'), 'Select platform');

            renderDictSelect('Shop', $('#sShop'), 'All shops');
            renderDictSelect('Shop', $('#shop_form'), 'Select shop');

            renderDictSelect('OrderStatus', $('#sStatus'), 'All status');
            renderDictSelect('OrderStatus', $('#status_form'), 'Select status');
        });

        // ======== Date pickers ========
        LaydateEn.render({
            elem: '#orderDateBegin',
            format: 'yyyy-MM-dd',
            type: 'date'
        });
        LaydateEn.render({
            elem: '#orderDateEnd',
            format: 'yyyy-MM-dd',
            type: 'date'
        });
        LaydateEn.render({
            elem: '#order_date_form',
            format: 'yyyy-MM-dd',
            type: 'date'
        });

        // ======== Table render ========
        var tableIns1 = table.render({
            elem: '#showTable',
            contentType: 'application/json',
            page: true,
            url: ctx + 'salesOrder/listByPage',
            method: 'POST',
            parseData: function (res) {
                return {
                    code: res.code,
                    msg: res.msg,
                    count: res.data ? res.data.total : 0,
                    data: res.data ? res.data.records : []
                };
            },
            cols: [
                [
                    {type: 'checkbox', fixed: 'left'},
                    {field: 'orderDate', title: 'Order Date', sort: true},
                    {
                        field: 'platformCode', title: 'Platform', templet: function (d) {
                            return getDictLabel('OrderPlatform', d.platformCode);
                        }
                    },
                    {
                        field: 'shopId', title: 'Shop', templet: function (d) {
                            return getDictLabel('Shop', d.shopId);
                        }
                    },
                    {field: 'platformOrderNo', title: 'Order No', sort: true},
                    {field: 'buyerPayAmount', title: 'Buyer Paid'},
                    {field: 'sellerReceivableAmount', title: 'Seller Receivable'},
                    {
                        field: 'orderStatus', title: 'Status', templet: function (d) {
                            return getDictLabel('OrderStatus', d.orderStatus);
                        }
                    },
                    {field: 'currency', title: 'Currency'},
                    {field: 'updatedTime', title: 'Updated Time', sort: true},
                    {toolbar: '#tool', title: 'Actions', fixed: 'right'}
                ]
            ],
            toolbar: '#toolbar'
        });

        // ======== Toolbar events ========
        table.on('toolbar(showTable)', function (obj) {
            switch (obj.event) {
                case 'batchDeleted':
                    var checkStatus = table.checkStatus(obj.config.id);
                    var data = checkStatus.data;
                    if (data.length === 0) {
                        layer.msg("Please select rows to delete.");
                    } else {
                        var ids = [];
                        $(data).each(function (index, item) {
                            ids.push(item.id);
                        });
                        tipDialog(ids);
                    }
                    break;
            }
        });

        // ======== Row tools ========
        table.on('tool(showTable)', function (obj) {
            var data = obj.data;
            switch (obj.event) {
                case 'del':
                    var ids = [data.id];
                    tipDialog(ids);
                    break;
                case 'look':
                    backshow(data);
                    toDisabled();
                    break;
                case 'edit':
                    backshow(data);
                    $(".title").html("Edit Order");
                    toUnDisabled();
                    break;
            }
        });

        // ======== Delete dialog ========
        var tipDialog = function (ids) {
            layer.open({
                content: "Are you sure to delete selected record(s)?",
                yes: function (index) {
                    layer.close(index);
                    CoreUtil.sendDelete(ctx + "salesOrder/delete", ids, function (res) {
                        layer.msg(res.msg, {time: 1000}, function () {
                            tableIns1.reload();
                        });
                    });
                }
            });
        };

        // ======== Back button ========
        $("#btn_cancel").click(function () {
            $(".table_div").show();
            $(".operation").hide();
            tableIns1.reload();
            return false;
        });

        // ======== Save (如果你后续允许手动编辑，可以保留逻辑) ========
        form.on('submit(submit)', function (data) {
            if (!data.field.orderDate) {
                layer.msg('Please select order date.');
                return false;
            }
            if (!data.field.platformCode) {
                layer.msg('Please select platform.');
                return false;
            }
            if (!data.field.shopId) {
                layer.msg('Please select shop.');
                return false;
            }

            if (!data.field.id) {
                CoreUtil.sendPost(ctx + "salesOrder/add", data.field, function (res) {
                    layer.msg(res.msg || 'Saved', {time: 800}, function () {
                        $(".table_div").show();
                        $(".operation").hide();
                        tableIns1.reload();
                    });
                });
            } else {
                CoreUtil.sendPut(ctx + "salesOrder/update", data.field, function (res) {
                    layer.msg(res.msg || 'Updated', {time: 800}, function () {
                        $(".table_div").show();
                        $(".operation").hide();
                        tableIns1.reload();
                    });
                });
            }
            return false;
        });

        // ======== Search ========
        form.on('submit(data-search-btn)', function (data) {
            var begin = data.field.orderDateBegin;
            var end = data.field.orderDateEnd;
            if (begin && end && begin > end) {
                layer.msg('End date cannot be earlier than start date.');
                return false;
            }
            tableIns1.reload({
                page: {curr: 1},
                where: data.field
            });
            return false;
        });

        // ======== Backfill form ========
        var backshow = function (data) {
            $(".table_div").hide();
            $(".operation").show();
            $(".title").html("View Order");
            setTimeout(function () {
                form.val('info', {
                    id: data.id,
                    orderDate: data.orderDate,
                    platformCode: data.platformCode,
                    shopId: data.shopId,
                    platformOrderNo: data.platformOrderNo,
                    orderStatus: data.orderStatus,
                    buyerPayAmount: data.buyerPayAmount,
                    sellerReceivableAmount: data.sellerReceivableAmount,
                    currency: data.currency,
                    remark: data.remark
                });
            }, 200);
        };

        // ======== Disable / Enable ========
        var toDisabled = function () {
            $(".oper").hide();
            $(".disabled").each(function (_, elem) {
                $(elem).attr("disabled", "disabled");
            });
            form.render('select');
        };
        var toUnDisabled = function () {
            $(".oper").show();
            $(".disabled").each(function (_, elem) {
                $(elem).removeAttr("disabled");
            });
            form.render('select');
        };

        // ======== Import orders (CSV) ========
        upload.render({
            elem: '#btn_import_orders',
            url: ctx + 'salesOrder/importOrders',
            accept: 'file',
            exts: 'csv|xlsx|xls',
            data: function () {
                var shopId = $('#sShop').val();
                if (!shopId) {
                    layer.msg('Please select a shop before importing.');
                }
                return {
                    shopId: shopId
                };
            },
            before: function () {
                var shopId = $('#sShop').val();
                if (!shopId) {
                    return false;
                }
                layer.load(1);
            },
            done: function (res) {
                layer.closeAll('loading');
                layer.msg(res.msg || 'Import finished.', {time: 1500}, function () {
                    tableIns1.reload({page: {curr: 1}});
                });
            },
            error: function () {
                layer.closeAll('loading');
                layer.msg('Upload failed, please retry.');
            }
        });
    });
</script>
